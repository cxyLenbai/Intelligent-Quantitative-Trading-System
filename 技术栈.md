# 智能量化交易系统技术栈

> 融合 AI 智能体的比特币/虚拟币智能量化交易系统
> 
> **目标**：研究、回测与实盘交易（含风控、监控与可视化）

---

## 总体架构

```
研究层（Notebook/批计算）
    ↓
回测与仿真层（事件驱动/向量化）
    ↓
执行与风控层（实盘交易、风险引擎）
    ↓
数据与特征层（实时/历史/衍生特征）
    ↓
智能体层（RAG+工具调用+治理）
    ↓
可观测性与运维层（监控、日志、告警）
    ↓
Web 可视化与运营后台
```

---

## 1. 核心语言与基础设施

### 编程语言
- **Python 3.11**：研究、回测、策略执行、数据处理
- **TypeScript**：Web 前端与后端服务
- **Bash/PowerShell**：运维脚本与自动化

### 容器与编排
- **Docker + docker-compose**：本地开发与准生产环境
- **Kubernetes**（可选）：生产环境扩展与高可用

---

## 2. 数据采集与行情

### 交易所接入
- **CCXT**：统一 REST API 接口（历史数据、交易执行）
  - 支持 100+ 交易所
  - 标准化接口：市场数据、订单管理、账户查询
- **Cryptofeed**：多交易所 WebSocket 实时行情
  - Trades、OrderBook、Ticker 实时推送
  - 低延迟、高吞吐
- **交易所官方 SDK**（备选）：
  - `python-binance`、`okx`、`bybit`
  - 用于低延迟交易与特殊功能

### 流式处理与缓存
- **Redis / Redis Streams**（MVP）：
  - 事件总线（行情分发、信号传递）
  - 缓存层（热数据、会话）
- **NATS / Kafka**（可选）：
  - 更高吞吐量
  - 多消费者、持久化

### 数据存储

#### 时序与关系型数据库
- **PostgreSQL + TimescaleDB**：
  - K 线数据（OHLCV）
  - Tick 数据（trades、orderbook snapshots）
  - 因子与特征
  - 账户、订单、成交记录
  - 审计日志

#### 数据湖
- **Parquet + MinIO/S3**：
  - 原始数据归档
  - 中间计算结果
  - 批量分析与回测

#### 向量数据库
- **pgvector**（PostgreSQL 扩展）：与主库共存
- **Qdrant / Milvus**（可选）：独立向量检索服务

#### 高性能分析（可选）
- **ClickHouse**：高吞吐查询与聚合
- **InfluxDB**：纯时序数据

### 数据质量保障
- 去重、时钟同步（NTP/Chrony）
- 缺失数据补齐
- 交易所 API 限频治理
- 数据字典与 Schema 管理

---

## 3. 策略研究与特征工程

### 数据科学生态
- **NumPy / Pandas / Polars**：数据处理与分析
- **Numba**：JIT 编译加速
- **Matplotlib / Plotly**：可视化

### 技术指标与特征库
- **ta / TA-Lib**：技术指标（MA、RSI、MACD 等）
- **tsfresh**：时序特征自动提取
- **featuretools**：自动化特征工程

### 标签生成
- **mlfinlab**：
  - 三重屏障标签（Triple Barrier）
  - 横截面标签
  - 金融机器学习工具集

### 机器学习框架

#### 传统模型
- **scikit-learn**：分类、回归、聚类、降维
- **Optuna**：超参数优化

#### 深度学习与时序预测
- **PyTorch**：深度学习框架
- **PyTorch Lightning**：训练流程简化
- **darts / pytorch-forecasting**：
  - RNN、LSTM、Transformer
  - 概率预测（Probabilistic Forecasting）

#### 强化学习（可选）
- **Stable-Baselines3**：强化学习算法库
- **Ray RLlib**：分布式强化学习
- 自定义交易环境（Gym 接口）

---

## 4. 回测与仿真

### 向量化回测
- **vectorbt**：
  - 高速多因子回测
  - 组合回测
  - 性能归因分析

### 事件驱动回测
- **backtesting.py / Backtrader**：
  - 逐笔撮合
  - 滑点模拟
  - 手续费计算
  - 信号延迟模拟

### 高级仿真（可选）
- L2 订单簿仿真
- 做市商冲击成本模型
- 交易规则与风控钩子

---

## 5. 执行、风控与组合管理

### 交易执行架构
```
信号总线 → 路由器（多交易所/品种） → OMS/EMS → Broker Adapter
```

#### 核心组件
- **交易路由器**：
  - 多账户/子账户管理
  - 多交易所、多品种
- **订单管理系统（OMS）**：
  - 订单生命周期管理
  - 订单状态追踪
- **持仓与资金管理（PM）**：
  - 实时持仓计算
  - 保证金与现金管理

#### 执行接口
- **REST**：CCXT 为主
- **WebSocket**：交易所官方 SDK（低延迟场景）

### 风控引擎

#### 风控层级
- **事前风控**：订单提交前校验
- **事中风控**：实时监控与熔断
- **事后风控**：复盘与归因

#### 风控规则
- 持仓限额（单品种、总持仓）
- 名义价值限制
- 杠杆倍数限制
- 单笔/日内最大亏损
- 熔断机制
- Kill-Switch（紧急停止）
- VaR / ES（风险价值）
- 最大回撤控制

#### 风控配置
- 规则 DSL（可配置）
- 动态参数调整
- 审计日志

### 组合与资金管理
- **PyPortfolioOpt**：
  - 权重优化
  - 约束条件
- 现金/保证金管理
- 对冲与再平衡策略

### 环境隔离
- **Dry-run**：模拟执行（不下真实订单）
- **Sandbox**：交易所测试环境
- **Production**：实盘环境

---

## 6. AI 智能体（Agent）层

### 编排与工具调用
- **LangChain / LlamaIndex**：
  - 工具调用（Function Calling）
  - 工作流编排
  - 记忆管理
- **Pydantic / JSON Schema**：
  - 结构化输出
  - 数据校验

### 工具集合
- **回测触发**：启动回测任务、参数配置
- **参数寻优**：超参数搜索、策略优化
- **指标/因子计算**：技术指标、自定义因子
- **数据查询**：历史数据、实时行情、账户状态
- **下单/撤单**（强审批）：
  - 人在回路（Human-in-the-Loop）
  - 权限控制
  - 审计日志

### 模型选择

#### 云端 LLM
- OpenAI GPT-4 / GPT-3.5
- Anthropic Claude
- Google Gemini
- 需要 API Key

#### 本地 LLM
- **Llama 3 / Qwen**：开源大模型
- **vLLM / Ollama**：推理加速与服务化

### RAG（检索增强生成）

#### 知识库
- 策略笔记
- 研究报告
- 交易日志
- 风控制度文档

#### 检索流程
```
用户查询 → 向量检索 → 上下文注入 → LLM 生成 → 结构化输出
```

#### 向量库
- **pgvector**（PostgreSQL 内置）
- **Qdrant / Milvus**（独立服务）

### 安全与治理

#### 人在回路审批
- 高风险工具（下单、撤单）需人工确认
- 审批流程与日志

#### 角色与权限
- RBAC（基于角色的访问控制）
- API 配额限制

#### 提示词与输出校验
- **Guardrails**：输出安全检查
- **Pydantic**：Schema 校验
- 防注入攻击

---

## 7. 可观测性与告警

### 监控与可视化
- **Prometheus**：指标采集与存储
- **Grafana**：可视化仪表盘
  - 系统指标（CPU、内存、网络）
  - 业务指标（订单量、成交率、PnL）
- **Alertmanager**：告警路由与通知

### 日志与追踪
- **结构化日志**：
  - `loguru` / `structlog`
  - JSON 格式
- **异常上报**：
  - **Sentry**：错误追踪与聚合
- **分布式追踪**：
  - **OpenTelemetry**：链路追踪

### 交易健康度指标
- **延迟**：订单提交到确认的时间
- **拒单率**：订单被拒绝的比例
- **滑点**：实际成交价与预期价的差异
- **成交率**：订单成交的比例
- **风控触发次数**：风控规则触发频率
- **策略收益归因**：PnL 来源分析

---

## 8. Web 前端与运营后台

### 前端技术栈
- **Next.js 14**：React 全栈框架
- **TypeScript**：类型安全
- **TailwindCSS**：样式框架
- **shadcn/ui**：组件库

### 图表与可视化
- **TradingView Lightweight Charts**：K 线图、指标图
- **Plotly**：交互式图表

### 实时通信
- **WebSocket / SSE**：实时行情、订单状态推送

### 后端 API
- **FastAPI**：
  - 高性能异步框架
  - 自动生成 OpenAPI 文档
  - Pydantic 数据校验
- **GraphQL**（可选）：灵活的数据查询

### 鉴权与权限
- **NextAuth / OAuth2**：用户认证
- **RBAC**：基于角色的访问控制
- **JWT**：无状态令牌

---

## 9. 基础设施与安全

### CI/CD
- **GitHub Actions**：
  - 自动化测试
  - Docker 镜像构建
  - 部署流水线

### 密钥与配置管理
- **HashiCorp Vault / 云 KMS**：密钥管理
- **12-Factor App**：配置与代码分离
- **Pydantic Settings**：环境变量管理

### 时间同步
- **NTP / Chrony**：确保时钟一致性（交易时间戳准确）

### 合规与风控
- **API Key 最小权限**：只读/交易分离
- **交易专用子账户**：资金隔离
- **IP 白名单**：限制访问来源
- **审计日志**：所有操作可追溯
- **只读提款权限**：防止资金被盗

---

## 10. MVP 选型（优先落地）

### 最小可用系统
- **接入**：CCXT + Cryptofeed
- **流与存储**：Redis Streams + TimescaleDB + Parquet
- **研究/回测**：vectorbt + backtesting.py
- **执行/风控**：
  - CCXT 下单
  - 统一风控模块
  - Dry-run 模式
- **Agent**：
  - LangChain + 本地 LLM（Ollama）
  - 三工具：回测触发、参数寻优、数据查询
  - 下单需人工审批
- **可观测**：Prometheus + Grafana + Sentry
- **可视化**：Next.js + TradingView Lightweight Charts

### 快速验证路径
1. 数据采集与存储（1-2 周）
2. 简单策略回测（1 周）
3. Dry-run 执行与风控（1-2 周）
4. 基础 Web 界面（1 周）
5. AI Agent 集成（2 周）

---

## 11. 可扩展选型（增长阶段）

### 高性能与高可用
- **Kafka / NATS**：高吞吐消息队列
- **ClickHouse**：海量数据分析
- **Ray / Dask**：分布式计算
- **Kubernetes**：容器编排与自动扩展

### 高级 AI 能力
- **vLLM**：高性能 LLM 推理
- **Ray RLlib**：分布式强化学习
- **Qdrant / Milvus**：独立向量检索服务

### 工作流编排
- **Temporal / Prefect**：
  - 复杂工作流编排
  - 批处理任务调度
  - 容错与重试

---

## 12. 技术选型原则

### 优先级
1. **稳定性 > 性能**：交易系统不能宕机
2. **可观测性 > 功能**：必须知道系统在做什么
3. **渐进式优化**：先跑通 MVP，再优化性能
4. **开源优先**：降低成本，社区支持

### 技术债务管理
- 定期重构
- 单元测试覆盖率 > 80%
- 代码审查（Code Review）
- 文档与注释

### 性能优化
- 数据库索引优化
- 缓存策略（Redis）
- 异步 I/O（asyncio）
- 批量操作
- 连接池管理

---

## 13. 风险提示

### 技术风险
- **交易所 API 稳定性**：限频、宕机、数据延迟
- **网络延迟**：影响高频策略
- **数据质量**：缺失、错误、延迟
- **系统故障**：服务宕机、数据库崩溃

### 业务风险
- **市场风险**：价格波动、流动性不足
- **策略失效**：过拟合、市场环境变化
- **资金安全**：API Key 泄露、账户被盗
- **合规风险**：监管政策变化

### 缓解措施
- 多重备份与容灾
- 实时监控与告警
- 风控规则严格执行
- 定期策略回测与验证
- 资金分散与隔离

---

## 14. 学习资源

### 量化交易
- 《Python for Finance》
- 《Advances in Financial Machine Learning》（Marcos López de Prado）
- 《Algorithmic Trading》（Ernest P. Chan）

### 机器学习与 AI
- 《Hands-On Machine Learning》
- 《Deep Learning》（Ian Goodfellow）
- LangChain / LlamaIndex 官方文档

### 系统设计
- 《Designing Data-Intensive Applications》
- 《Site Reliability Engineering》（Google SRE）

### 社区与论坛
- QuantConnect、Quantopian 社区
- Reddit: r/algotrading
- GitHub: awesome-quant

---

## 15. 下一步行动

### 立即开始
1. **明确交易范围**：
   - 现货 / 合约？
   - 目标交易所（Binance、OKX、Bybit）？
   - 延迟目标（高频 / 中低频）？

2. **搭建开发环境**：
   - Docker + docker-compose
   - PostgreSQL + TimescaleDB
   - Redis

3. **数据采集 POC**：
   - CCXT 获取历史 K 线
   - Cryptofeed 订阅实时行情
   - 存入 TimescaleDB

4. **简单策略回测**：
   - 双均线策略
   - vectorbt 回测
   - 性能评估

5. **Dry-run 执行**：
   - 模拟下单
   - 风控规则验证

### 长期规划
- 策略库建设
- AI Agent 工具扩展
- 多交易所支持
- 高可用架构
- 合规与审计

---

## 附录：目录结构建议

```
Intelligent-Quantitative-Trading-System/
├── data/                      # 数据层
│   ├── collectors/            # 数据采集
│   ├── storage/               # 存储适配器
│   └── quality/               # 数据质量检查
├── features/                  # 特征工程
│   ├── indicators/            # 技术指标
│   ├── factors/               # 因子计算
│   └── labels/                # 标签生成
├── research/                  # 研究与实验
│   ├── notebooks/             # Jupyter Notebooks
│   └── experiments/           # 实验记录
├── backtest/                  # 回测引擎
│   ├── vectorized/            # 向量化回测
│   └── event_driven/          # 事件驱动回测
├── strategy/                  # 策略库
│   ├── signals/               # 信号生成
│   └── portfolio/             # 组合管理
├── execution/                 # 执行层
│   ├── router/                # 交易路由
│   ├── oms/                   # 订单管理
│   └── adapters/              # 交易所适配器
├── risk/                      # 风控引擎
│   ├── rules/                 # 风控规则
│   └── monitor/               # 实时监控
├── agent/                     # AI 智能体
│   ├── tools/                 # 工具集
│   ├── rag/                   # RAG 检索
│   └── workflows/             # 工作流
├── api/                       # Web API
│   ├── routes/                # 路由
│   └── schemas/               # 数据模型
├── web/                       # 前端
│   ├── components/            # 组件
│   ├── pages/                 # 页面
│   └── hooks/                 # 自定义 Hooks
├── infra/                     # 基础设施
│   ├── docker/                # Docker 配置
│   ├── k8s/                   # Kubernetes 配置
│   └── monitoring/            # 监控配置
├── tests/                     # 测试
│   ├── unit/                  # 单元测试
│   ├── integration/           # 集成测试
│   └── e2e/                   # 端到端测试
├── docs/                      # 文档
├── scripts/                   # 脚本
├── docker-compose.yml         # 本地开发环境
├── requirements.txt           # Python 依赖
├── package.json               # Node.js 依赖
└── README.md                  # 项目说明
```

---

**版本**：v1.0  
**更新日期**：2025-10-30  
**维护者**：Intelligent Quantitative Trading System Team
